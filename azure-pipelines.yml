# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

pool:
  vmImage: 'windows-latest'

variables:
  doxygenUrl: "https://www.doxygen.nl/files/doxygen-1.9.2.windows.x64.bin.zip"
  doxygenWorkingDir: '$(Pipeline.Workspace)\Documentation\Doxygen'
  doxygenOutputDir: '$(Pipeline.Workspace)\Documentation\Output'
steps:
- checkout: self
  clean: true
  persistCredentials: true

- task: Cache@2
  displayName: "Cache Doxygen Install"
  inputs:
    key: '"$(doxygenUrl)"'
    path: $(doxygenWorkingDir)
    cacheHitVar: 'CACHE_RESTORED'

- task: PowerShell@2
  displayName: "Download Doxygen"
  condition: ne(variables.CACHE_RESTORED, 'true')
  inputs:
    targetType: 'inline'
    script: |
      $doxygenUrl = ${env:doxygenUrl}
      $outpath = ${env:doxygenWorkingDir}
      
      if(!(Test-Path $outpath))
      {
      	Write-Host "Creating $outpath";
      	New-Item -ItemType Directory -Force -Path $outpath
      }
      $zipDownloadPath = "$outpath\" + $(Split-Path -Path $doxygenUrl -Leaf)
      Write-Host "Downloading from $doxygenUrl to $zipDownloadPath"
      
      Invoke-WebRequest -Uri $doxygenUrl -OutFile $zipDownloadPath
      Expand-Archive -LiteralPath $zipDownloadPath -DestinationPath $outpath
      Remove-Item $zipDownloadPath

- task: PowerShell@2
  displayName: "Commit Documentation to GitHub Pages"
  inputs:
    targetType: 'inline'
    script: |
      git config user.email "hen.bagle@gmail.com"
      git config user.name "ME3Tweaks-LEC-Documentation"
      $(doxygenWorkingDir)\doxygen.exe $(Build.SourcesDirectory)\Documentation\DoxygenConfigAzurePipelines
      "Test git changes" | Out-File -FilePath .\CONTRIBUTING.md
      git restore .\CONTRIBUTING.md
      git checkout gh-pages
      if(Test-Path .\nightly\)
      {
        Remove-Item .\nightly\* -Recurse
      }
      Copy-Item -Path "$(doxygenOutputDir)\html\**" -Destination .\nightly -Recurse
      git add .\nightly\**
      git commit -m "Update documentation [skip ci]"
      git push origin gh-pages